<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cozy Autumn Scene</title>
  <style>
    :root{--shadow:2px 2px 4px rgba(0,0,0,.7)}
    *{box-sizing:border-box;margin:0;padding:0}
    body{height:100vh;overflow:hidden;position:relative;font-family:system-ui,sans-serif}
    body::before{content:"";position:fixed;inset:0;background:linear-gradient(to bottom, #87CEEB 0%, #FFB84D 60%, #FF9F5A 100%);z-index:1}
    
    #clouds{position:fixed;inset:0;z-index:3;pointer-events:none}
    #fog{position:fixed;inset:0;z-index:4;pointer-events:none}
    #people{position:fixed;bottom:0;left:0;width:100%;height:50%;z-index:6;pointer-events:none}
    #leafCarpet{position:fixed;bottom:0;left:0;width:100%;height:120px;z-index:7;pointer-events:none;overflow:hidden}
    
    canvas{position:fixed;inset:0;width:100vw;height:100vh;z-index:8;pointer-events:none}
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:9;display:none;pointer-events:none}
    
    #date{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10;font-size:28px;padding:8px 14px;border-radius:12px;background:rgba(0,0,0,.18);backdrop-filter:blur(3px);color:#fff;text-shadow:var(--shadow)}
    #startSound{position:absolute;left:50%;bottom:20px;transform:translateX(-50%);z-index:20;padding:10px 18px;border:none;border-radius:10px;font-size:16px;color:#fff;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);cursor:pointer}
    #errors{position:fixed;right:10px;bottom:10px;z-index:30;max-width:40ch;padding:8px 10px;border-radius:8px;font:12px/1.3 system-ui;background:rgba(0,0,0,.6);color:#fdd;display:none;white-space:pre-wrap}
    
    .cloud,.fog{position:absolute;border-radius:50%}
    .fog{background:rgba(255,255,255,.25);filter:blur(40px)}
    .person{position:absolute;bottom:0}
    
    @media(max-width:768px){
      #date{font-size:20px;padding:6px 10px}
      #startSound{font-size:14px;padding:8px 14px;bottom:15px}
      #road{height:35%}
      #buildings{height:40%;bottom:18%}
      .building{height:70%}
    }
  </style>
</head>
<body>
  <div id="date"></div>
  <button id="startSound">▶ Play Sound</button>
  <div id="clouds"></div>
  <div id="fog"></div>
  <div id="road"></div>
  <div id="people"></div>
  <div id="leafCarpet"></div>
  <canvas id="canvas"></canvas>
  <div id="overlay"></div>
  <div id="errors"></div>

  <script>
    const $=(s)=>document.getElementById(s);
    const [dateEl,canvas,ctx,errBox,startBtn,peopleEl]=[$("date"),$("canvas"),$("canvas").getContext("2d"),$("errors"),$("startSound"),$("people")];
    
    dateEl.textContent=new Date().toLocaleDateString("en-US",{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    
    const leafSrc=["autumn/images_autumn/leaves/leaf1.png","autumn/images_autumn/leaves/leaf2.png","autumn/images_autumn/leaves/leaf3.png","autumn/images_autumn/leaves/leaf4.png"];
    
    // Люди по типам погоды
    const peopleSrc={
      chilling:"autumn/images_autumn/people/chilling.png",
      coffee:"autumn/images_autumn/people/coffee.png",
      running:"autumn/images_autumn/people/running.png",
      umbrella:"autumn/images_autumn/people/umbrella.png"
    };
    
    const showErr=(m)=>{errBox.style.display="block";errBox.textContent+=(errBox.textContent?"\n":"")+m;console.error(m)};
    
    const preload=(srcs)=>Promise.allSettled(srcs.map(s=>new Promise((res,rej)=>{
      const i=new Image();i.onload=()=>res(i);i.onerror=()=>rej(new Error("Not found: "+s));i.src=s;
    }))).then(r=>{r.filter(x=>x.status==="rejected").forEach(x=>showErr(x.reason.message));return r.filter(x=>x.status==="fulfilled").map(x=>x.value)});
    
    const preloadPeople=()=>Promise.all(Object.entries(peopleSrc).map(([k,v])=>
      preload([v]).then(imgs=>({type:k,img:imgs[0]}))
    )).then(arr=>arr.filter(x=>x.img));
    
    const resize=()=>{canvas.width=innerWidth;canvas.height=innerHeight};
    resize();addEventListener("resize",resize);
    
    class Leaf{
      constructor(imgs){this.imgs=imgs;this.reset(1)}
      reset(f=0){const w=canvas.width,h=canvas.height;this.x=Math.random()*w;this.y=f?Math.random()*-h:-20;this.size=24+Math.random()*36;this.speed=1+Math.random()*2;this.angle=Math.random()*Math.PI*2;this.spin=.01+Math.random()*.02;this.img=this.imgs.length?this.imgs[~~(Math.random()*this.imgs.length)]:null;this.color=["#ff9f1c","#ffbf69","#d62828","#f77f00"][~~(Math.random()*4)]}
      update(){this.y+=this.speed;this.angle+=this.spin;this.x+=Math.sin(this.angle)*.6;if(this.y>canvas.height+this.size)this.reset()}
      draw(){ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.angle);if(this.img)ctx.drawImage(this.img,-this.size/2,-this.size/2,this.size,this.size);else{ctx.fillStyle=this.color;ctx.beginPath();ctx.ellipse(0,0,this.size/2.2,this.size/1.3,0,0,Math.PI*2);ctx.fill();ctx.strokeStyle="rgba(0,0,0,.15)";ctx.stroke()}ctx.restore()}
    }
    
    class Raindrop{
      constructor(h=0){this.h=h;this.reset(1)}
      reset(f=0){const w=canvas.width,h=canvas.height;this.x=Math.random()*w;this.y=f?Math.random()*-h:-10;this.len=this.h?20+Math.random()*10:10+Math.random()*6;this.speed=this.h?8+Math.random()*4:4+Math.random()*3;this.op=this.h?.6:.35}
      update(){this.y+=this.speed;if(this.y>canvas.height+this.len)this.reset()}
      draw(){ctx.strokeStyle=`rgba(255,255,255,${this.op})`;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(this.x,this.y);ctx.lineTo(this.x,this.y+this.len);ctx.stroke()}
    }
    
    class WindLine{
      constructor(dir=1){this.dir=dir;this.reset()}
      reset(){this.y=Math.random()*canvas.height;this.len=100+Math.random()*220;this.speed=1+Math.random()*2;this.amp=18+Math.random()*28;this.freq=.01+Math.random()*.02;this.x=this.dir>0?-this.len:canvas.width+this.len;this.op=.12+Math.random()*.1}
      update(){this.x+=this.speed*2*this.dir;if(this.dir>0&&this.x>canvas.width+this.len)this.reset();if(this.dir<0&&this.x<-this.len)this.reset()}
      draw(){ctx.strokeStyle=`rgba(255,255,255,${this.op})`;ctx.lineWidth=2;ctx.beginPath();for(let i=0;i<this.len;i+=10){const px=this.x+i*this.dir,py=this.y+Math.sin(i*this.freq+Date.now()*.002)*this.amp;i?ctx.lineTo(px,py):ctx.moveTo(px,py)}ctx.stroke()}
    }
    
    const rain=new Audio("autumn/sounds_autumn/rain.mp3"),rainfall=new Audio("autumn/sounds_autumn/rainfall.mp3"),wind=new Audio("autumn/sounds_autumn/wind.mp3");
    rain.loop=rainfall.loop=wind.loop=1;rainfall.volume=.3;rain.volume=wind.volume=.5;
    
    const mode=~~(Math.random()*5),cloudArr=[];
    startBtn.onclick=()=>{[wind,rain,rainfall,rain,wind][mode]?.play().catch(()=>{});startBtn.style.display="none"};
    
    const makeClouds=(hvy=0)=>{
      const c=$("clouds");c.innerHTML="";cloudArr.length=0;
      for(let i=0;i<(hvy?20:12);i++){
        const d=document.createElement("div");d.className="cloud";
        const w=120+Math.random()*180,h=60+Math.random()*80;
        d.style.width=w+"px";d.style.height=h+"px";d.style.top=(Math.random()*15)+"px";
        const fL=Math.random()<.5,sX=fL?-200+Math.random()*innerWidth/2:innerWidth-Math.random()*innerWidth/2;
        d.style.left=sX+"px";
        if(hvy){d.style.background="rgba(50,50,50,.85)";d.style.filter="blur(10px)";d.style.opacity=.9}
        else{d.style.background="rgba(255,255,255,.8)";d.style.filter="blur(12px)";d.style.opacity=.7}
        c.appendChild(d);cloudArr.push({el:d,fL,speed:.2+Math.random()*.3})
      }
    };
    
    const moveClouds=()=>{
      for(const c of cloudArr){let p=parseFloat(c.el.style.left);p+=c.fL?c.speed:-c.speed;if(c.fL&&p>innerWidth+200)p=-300;if(!c.fL&&p<-400)p=innerWidth+200;c.el.style.left=p+"px"}
      requestAnimationFrame(moveClouds)
    };
    
    const makeFog=()=>{
      const f=$("fog");f.innerHTML="";
      for(let i=0;i<4;i++){const d=document.createElement("div");d.className="fog";d.style.width=(300+Math.random()*400)+"px";d.style.height=(100+Math.random()*200)+"px";d.style.bottom=(Math.random()*15)+"%";d.style.left=(Math.random()*80)+"%";d.style.opacity=.25+Math.random()*.15;f.appendChild(d)}
    };
    
    const addPeople=(peopleData,weatherMode)=>{
      if(!peopleData.length)return;
      peopleEl.innerHTML="";
      const w=innerWidth,h=innerHeight;
      const isMobile=w<768;
      
      // Режимы: 0-ветер/листья, 1-лёгкий дождь, 2-сильный дождь, 3-дождь+листья, 4-сильный ветер
      let available=[];
      if(weatherMode===0||weatherMode===4){
        // Без дождя - chilling и coffee
        available=peopleData.filter(p=>p.type==="chilling"||p.type==="coffee");
        // Показываем 1-2 персонажа случайно
        available=available.sort(()=>Math.random()-.5).slice(0,Math.random()<.5?1:2);
      }else if(weatherMode===1||weatherMode===3){
        // Лёгкий дождь - umbrella
        available=peopleData.filter(p=>p.type==="umbrella");
      }else if(weatherMode===2){
        // Сильный дождь/гроза - running
        available=peopleData.filter(p=>p.type==="running");
      }
      
      if(!available.length)return;
      
      const sz=h*0.5; // 50% высоты экрана
      const positions=available.length===1?[.5]:(available.length===2?[.3,.7]:[.2,.5,.8]);
      
      available.forEach((p,i)=>{
        const im=p.img.cloneNode();
        im.className="person";
        im.style.height=sz+"px";
        im.style.left=(positions[i]*w)+"px";
        im.style.transform=`translateX(-50%)`;
        im.style.bottom="40px"; // Опущены ниже, ходят по синей линии (ближе к листьям)
        peopleEl.appendChild(im);
        
        // Анимация ходьбы
        let pos=positions[i]*w;
        const isRunning=p.type==="running";
        // Для running - вправо (по +x), для остальных - влево (по -x)
        const speed=(Math.random()*.5+.3)*(isRunning?1:-1);
        const animate=()=>{
          pos+=speed;
          if(pos<-100)pos=w+100;
          if(pos>w+100)pos=-100;
          im.style.left=pos+"px";
          requestAnimationFrame(animate);
        };
        animate();
      });
    };
    
    const carpet=(imgs)=>{
      const c=$("leafCarpet");c.innerHTML="";const w=innerWidth;
      const isMobile=w<768;
      const layers=isMobile?
        [{d:~~(w/25),s:[40,60],o:1,z:3},{d:~~(w/30),s:[25,45],o:.85,z:2},{d:~~(w/35),s:[15,30],o:.7,z:1}]:
        [{d:~~(w/18),s:[50,80],o:1,z:3},{d:~~(w/22),s:[35,55],o:.85,z:2},{d:~~(w/26),s:[20,40],o:.7,z:1}];
      layers.forEach(l=>{
        for(let i=0;i<l.d;i++){
          const im=imgs[~~(Math.random()*imgs.length)].cloneNode();
          im.style.position="absolute";
          im.style.bottom=-(Math.random()*10)+"px";
          im.style.left=Math.random()*w+"px";
          const sz=l.s[0]+Math.random()*(l.s[1]-l.s[0]);
          im.style.width=sz+"px";
          im.style.transform=`rotate(${Math.random()*360}deg)`;
          im.style.opacity=l.o;
          im.style.zIndex=l.z;
          c.appendChild(im)
        }
      })
    };
    
    let leaves=[],drops=[],winds=[],leafImgs=[],peopleData=[];
    const build=()=>{
      if([0,3,4].includes(mode)){const n=[40,30,30,30,50][mode];for(let i=0;i<n;i++)leaves.push(new Leaf(leafImgs))}
      if([1,2,3].includes(mode)){const h=mode===2,n=h?200:(mode===3?120:100);for(let i=0;i<n;i++)drops.push(new Raindrop(h))}
      if([0,4].includes(mode)){const n=mode===4?7:5;for(let i=0;i<n;i++)winds.push(new WindLine(1))}
      if(mode===2){$("overlay").style.display="block";makeClouds(1);for(let i=0;i<7;i++)winds.push(new WindLine(-1))}
      else if([1,3].includes(mode)){makeClouds(0);if(Math.random()<.3)makeFog()}
      else if([0,4].includes(mode)&&Math.random()<.1)makeFog();
      carpet(leafImgs);
      addPeople(peopleData,mode);
      moveClouds()
    };
    
    const anim=()=>{ctx.clearRect(0,0,canvas.width,canvas.height);leaves.forEach(l=>{l.update();l.draw()});drops.forEach(d=>{d.update();d.draw()});winds.forEach(w=>{w.update();w.draw()});requestAnimationFrame(anim)};
    
    Promise.all([preload(leafSrc),preloadPeople()]).then(([lImgs,pData])=>{leafImgs=lImgs;peopleData=pData;build();anim()});
  </script>
</body>
</html>
